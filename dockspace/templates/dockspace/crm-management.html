{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Management | Dockspace</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <base href="{% static '' %}">
        <link rel="shortcut icon" href="images/favicon.ico">
        <link href="assets/css/icons.min.css" rel="stylesheet" type="text/css" />
        <link href="assets/css/app.min.css" rel="stylesheet" type="text/css" id="app-style"/>

    </head>

<body class="loading" data-layout-color="light" data-leftbar-theme="dark" data-layout-mode="fluid" data-rightbar-onstart="false">
        <!-- Begin page -->
        <div class="wrapper">
            {% include "dockspace/components/left-sidebar.html" %}

            <!-- ============================================================== -->
            <!-- Start Page Content here -->
            <!-- ============================================================== -->

            <div class="content-page">
                <div class="content">
                    {% include "dockspace/components/header.html" %}

                    <!-- Start Content-->
                    <div class="container-fluid">
                        
                        <!-- start page title -->
                        <div class="row">
                            <div class="col-12">
                                <div class="page-title-box">
                                    <div class="page-title-right">
                                        <ol class="breadcrumb m-0">
                                            <li class="breadcrumb-item"><a href="javascript: void(0);">Dockspace</a></li>
                                            <li class="breadcrumb-item active">Mail & OIDC</li>
                                        </ol>
                                    </div>
                                    <h4 class="page-title">Mail & Identity Management</h4>
                                </div>
                            </div>
                        </div>
                        <!-- end page title --> 

                        {% if messages %}
                        <div class="row">
                            <div class="col-12">
                                {% for message in messages %}
                                    <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags|default:'info' }}{% endif %} alert-dismissible bg-{% if message.tags == 'error' %}danger{% else %}{{ message.tags|default:'info' }}{% endif %} text-white border-0 fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="row">
                            <div class="col-xl-6">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h4 class="header-title mb-0">Recently updated mail accounts</h4>
                                            <span class="badge bg-primary-subtle text-primary">{{ recent_updated|length }}</span>
                                        </div>
                                        {% if recent_updated %}
                                            <ul class="list-group list-group-flush">
                                                {% for acct in recent_updated %}
                                                    <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <a href="{% url 'dockspace:account_profile_admin' acct.id %}" class="fw-semibold text-decoration-none">
                                                                {{ acct.email }}
                                                            </a>
                                                            <div class="text-muted small">Updated {{ acct.updated_at|date:"Y-m-d H:i" }}</div>
                                                        </div>
                                                        <span class="badge bg-light text-primary">{{ acct.mail_quota.quota_string|default:"No quota" }}</span>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-muted mb-0">No recent updates.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="col-xl-6">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h4 class="header-title mb-0">Recently created mail accounts</h4>
                                            <span class="badge bg-primary-subtle text-primary">{{ recent_created|length }}</span>
                                        </div>
                                        {% if recent_created %}
                                            <ul class="list-group list-group-flush">
                                                {% for acct in recent_created %}
                                                    <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <a href="{% url 'dockspace:account_profile_admin' acct.id %}" class="fw-semibold text-decoration-none">
                                                                {{ acct.email }}
                                                            </a>
                                                            <div class="text-muted small">Created {{ acct.created_at|date:"Y-m-d H:i" }}</div>
                                                        </div>
                                                        <span class="badge bg-light text-primary">{{ acct.mail_quota.quota_string|default:"No quota" }}</span>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-muted mb-0">No new accounts yet.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xxl-8">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div>
                                                <h4 class="header-title mb-1">Accounts</h4>
                                                <p class="text-muted mb-0">Edit quotas, aliases, and group memberships per account.</p>
                                            </div>
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="badge bg-secondary">{{ accounts|length }} total</span>
                                                <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleAccountCreate()">New account</button>
                                            </div>
                                        </div>

                                        <!-- Create Account Form -->
                                        <div id="account-create-form" class="d-none mb-3">
                                            <div class="border rounded p-3 bg-light">
                                                <h6 class="fw-semibold mb-3">Create new account</h6>
                                                <form method="post" class="row g-3">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="create_account">
                                                    {% for field in account_create_form %}
                                                        <div class="col-md-6">
                                                            <label class="form-label small fw-semibold" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                            {{ field }}
                                                            {% if field.help_text %}<small class="text-muted d-block mt-1">{{ field.help_text }}</small>{% endif %}
                                                            {% if field.errors %}<div class="text-danger small mt-1">{{ field.errors|join:", " }}</div>{% endif %}
                                                        </div>
                                                    {% endfor %}
                                                    <div class="col-12">
                                                        <small class="text-muted">
                                                            <i class="mdi mdi-information-outline me-1"></i>All fields are required. Password must be at least 8 characters.
                                                        </small>
                                                    </div>
                                                    <div class="col-12 d-flex justify-content-between mt-2">
                                                        <button class="btn btn-primary btn-sm" type="submit">
                                                            <i class="mdi mdi-account-plus me-1"></i>Create account
                                                        </button>
                                                        <button class="btn btn-light btn-sm" type="button" onclick="toggleAccountCreate()">Cancel</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>

                                        <div class="accordion" id="accountAccordion">
                                            {% for acct in accounts %}
                                                <div class="accordion-item mb-2">
                                                    <h2 class="accordion-header" id="acct-heading-{{ acct.id }}">
                                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acct-body-{{ acct.id }}" aria-expanded="false" aria-controls="acct-body-{{ acct.id }}">
                                                            <div class="d-flex flex-column flex-md-row w-100 align-items-start align-items-md-center">
                                                                <a href="{% url 'dockspace:account_profile_admin' acct.id %}" class="fw-semibold me-3 text-decoration-none" onclick="event.stopPropagation();">
                                                                    {{ acct.email }}
                                                                    <i class="mdi mdi-open-in-new ms-1 small"></i>
                                                                </a>
                                                                <span class="text-muted small me-3">@{{ acct.username }}</span>
                                                                <span class="text-muted small">Updated {{ acct.updated_at|date:"Y-m-d H:i" }}</span>
                                                            </div>
                                                        </button>
                                                    </h2>
                                                    <div id="acct-body-{{ acct.id }}" class="accordion-collapse collapse" aria-labelledby="acct-heading-{{ acct.id }}" data-bs-parent="#accountAccordion">
                                                        <div class="accordion-body">
                                                            <div class="row g-3">
                                                                <div class="col-md-4">
                                                                    <div class="border rounded p-3 h-100 d-flex flex-column">
                                                                        <h6 class="fw-semibold mb-2">Groups</h6>
                                                                        <form method="post" class="d-flex flex-column flex-grow-1">
                                                                            {% csrf_token %}
                                                                            <input type="hidden" name="action" value="update_groups">
                                                                            <input type="hidden" name="account_id" value="{{ acct.id }}">
                                                                            <div class="list-group mb-3 flex-grow-1">
                                                                                {% for group in groups %}
                                                                                    <label class="list-group-item py-2">
                                                                                        <input class="form-check-input me-2" type="checkbox" name="groups" value="{{ group.id }}" {% if group in acct.mail_groups.all %}checked{% endif %}>
                                                                                        {{ group.name }}
                                                                                    </label>
                                                                                {% empty %}
                                                                                    <div class="text-muted small">No groups available.</div>
                                                                                {% endfor %}
                                                                            </div>
                                                                            <div class="text-end mt-auto pt-2">
                                                                                <button class="btn btn-sm btn-outline-primary" type="submit">Save</button>
                                                                            </div>
                                                                        </form>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <div class="border rounded p-3 h-100 d-flex flex-column">
                                                                        <h6 class="fw-semibold mb-2">Aliases</h6>
                                                                        <form method="post" class="d-flex flex-column flex-grow-1">
                                                                            {% csrf_token %}
                                                                            <input type="hidden" name="action" value="update_aliases">
                                                                            <input type="hidden" name="account_id" value="{{ acct.id }}">
                                                                            <div class="flex-grow-1">
                                                                                {% if acct.mail_aliases.all|length %}
                                                                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                                                                        <span class="text-muted small">Alias</span>
                                                                                        <span class="text-danger small fw-semibold">Delete</span>
                                                                                    </div>
                                                                                    <ul class="list-unstyled mb-2">
                                                                                        {% for alias in acct.mail_aliases.all %}
                                                                                            <li class="d-flex justify-content-between align-items-center mb-1">
                                                                                                <span>{{ alias.alias }}</span>
                                                                                                <input class="form-check-input" type="checkbox" name="remove_aliases" value="{{ alias.id }}" aria-label="Delete alias {{ alias.alias }}">
                                                                                            </li>
                                                                                        {% endfor %}
                                                                                    </ul>
                                                                                {% else %}
                                                                                    <p class="text-muted small mb-2">No aliases.</p>
                                                                                {% endif %}
                                                                                <input type="email" name="new_alias" class="form-control mb-1" placeholder="alias@example.com">
                                                                                <small class="text-muted">Add a new alias, then save.</small>
                                                                            </div>
                                                                            <div class="text-end mt-auto pt-2">
                                                                                <button class="btn btn-sm btn-outline-primary" type="submit">Save</button>
                                                                            </div>
                                                                        </form>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <div class="border rounded p-3 h-100 d-flex flex-column">
                                                                        <h6 class="fw-semibold mb-2">Quota</h6>
                                                                        <form method="post" class="d-flex flex-column flex-grow-1">
                                                                            {% csrf_token %}
                                                                            <input type="hidden" name="action" value="update_quota">
                                                                            <input type="hidden" name="account_id" value="{{ acct.id }}">
                                                                            <div class="d-flex gap-2 flex-grow-1 align-items-start">
                                                                                <input type="number" name="size_value" value="{% if acct.mail_quota %}{{ acct.mail_quota.size_value }}{% endif %}" min="1" class="form-control" placeholder="Size">
                                                                                <select name="suffix" class="form-select" style="max-width: 110px;">
                                                                                    {% for choice, label in quota_form.fields.suffix.choices %}
                                                                                        <option value="{{ choice }}" {% if acct.mail_quota and acct.mail_quota.suffix == choice %}selected{% endif %}>{{ label }}</option>
                                                                                    {% endfor %}
                                                                                </select>
                                                                            </div>
                                                                            <div class="text-end mt-auto pt-2">
                                                                                <button class="btn btn-sm btn-outline-primary" type="submit">Save</button>
                                                                            </div>
                                                                        </form>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% empty %}
                                                <p class="text-muted mb-0">No accounts available.</p>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-xxl-4">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h4 class="header-title mb-0">Groups</h4>
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="badge bg-secondary">{{ groups|length }}</span>
                                                <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleGroupCreate()">New group</button>
                                            </div>
                                        </div>

                                        <!-- Create Group Form - Hidden by default -->
                                        <div id="group-create-form" class="d-none mb-3">
                                            <div class="border rounded p-3">
                                                <h6 class="fw-semibold mb-2">Create new group</h6>
                                                <form method="post" class="row g-2">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="create_group">
                                                    <div class="col-12">
                                                        {{ group_form.name }}
                                                        {% if group_form.name.errors %}
                                                            <div class="text-danger small mt-1">{{ group_form.name.errors|join:", " }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-12 d-flex justify-content-between">
                                                        <button class="btn btn-primary btn-sm" type="submit">Add group</button>
                                                        <button class="btn btn-light btn-sm" type="button" onclick="toggleGroupCreate()">Cancel</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>

                                        {% if groups %}
                                            <ul class="list-group list-group-flush">
                                                {% for group in groups %}
                                                    <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                                        <div id="group-view-{{ group.id }}" class="d-flex flex-wrap align-items-center w-100 gap-2">
                                                            <div class="flex-grow-1">
                                                                <span class="fw-semibold">{{ group.name }}</span>
                                                                <span class="text-muted small ms-2">{{ group.members.count }} member{{ group.members.count|pluralize }}</span>
                                                            </div>
                                                            <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleGroupEdit('{{ group.id }}')">Edit</button>
                                                        </div>
                                                        <div id="group-edit-{{ group.id }}" class="d-none w-100 mt-2">
                                                            <form method="post" class="row g-2 align-items-center" id="rename-form-{{ group.id }}">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="action" value="update_group">
                                                                <input type="hidden" name="group_id" value="{{ group.id }}">
                                                                <div class="col-12">
                                                                    <label class="form-label mb-1" for="group-name-{{ group.id }}">Group name</label>
                                                                    <input id="group-name-{{ group.id }}" type="text" class="form-control form-control-sm" name="name" value="{{ group.name }}" aria-label="Group name" required>
                                                                </div>
                                                                <div class="col-12 d-flex justify-content-between align-items-center">
                                                                    <div class="d-flex gap-2">
                                                                        <button class="btn btn-primary btn-sm" type="submit">Rename</button>
                                                                        <button class="btn btn-light btn-sm" type="button" onclick="toggleGroupEdit('{{ group.id }}')">Cancel</button>
                                                                    </div>
                                                                    <form method="post" class="d-inline" onsubmit="return confirm('Delete this group? This action cannot be undone.');">
                                                                        {% csrf_token %}
                                                                        <input type="hidden" name="action" value="delete_group">
                                                                        <input type="hidden" name="group_id" value="{{ group.id }}">
                                                                        <button class="btn btn-outline-danger btn-sm" type="submit">
                                                                            <i class="mdi mdi-delete"></i>
                                                                        </button>
                                                                    </form>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-muted mb-0">No groups yet.</p>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div>
                                                <h4 class="header-title mb-0">OIDC Clients</h4>
                                                <p class="text-muted small mb-0 mt-1">Manage OAuth/OIDC clients and their group access permissions.</p>
                                            </div>
                                            <span class="badge bg-secondary">{{ clients|length }}</span>
                                        </div>

                                        {% if clients %}
                                            <div class="accordion mb-3" id="clientAccordion">
                                                {% for client in clients %}
                                                    {% with access=client.access %}
                                                    <div class="accordion-item mb-2">
                                                        <h2 class="accordion-header" id="client-heading-{{ client.id }}">
                                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#client-body-{{ client.id }}" aria-expanded="false" aria-controls="client-body-{{ client.id }}">
                                                                <div class="d-flex flex-column flex-md-row w-100 align-items-start align-items-md-center">
                                                                    <span class="fw-semibold me-3">{{ client.name|default:client.client_id }}</span>
                                                                    <span class="text-muted small me-3">ID: <code class="small">{{ client.client_id }}</code></span>
                                                                    {% if access.groups.all %}
                                                                        <span class="badge bg-info-subtle text-info me-2">{{ access.groups.count }} group{{ access.groups.count|pluralize }}</span>
                                                                    {% else %}
                                                                        <span class="badge bg-success-subtle text-success me-2">Open access</span>
                                                                    {% endif %}
                                                                    {% if access and access.require_2fa %}
                                                                        <span class="badge bg-warning-subtle text-warning me-2"><i class="mdi mdi-shield-lock-outline"></i> 2FA required</span>
                                                                    {% endif %}
                                                                    <span class="text-muted small">Created {% if client.date_created %}{{ client.date_created|date:"Y-m-d" }}{% else %}&mdash;{% endif %}</span>
                                                                </div>
                                                            </button>
                                                        </h2>
                                                        <div id="client-body-{{ client.id }}" class="accordion-collapse collapse" aria-labelledby="client-heading-{{ client.id }}" data-bs-parent="#clientAccordion">
                                                            <div class="accordion-body">
                                                                <!-- Client Actions -->
                                                                <div class="d-flex flex-wrap gap-2 mb-3">
                                                                    <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#clientEditCollapse-{{ client.id }}" aria-expanded="false" aria-controls="clientEditCollapse-{{ client.id }}">
                                                                        <i class="mdi mdi-pencil me-1"></i>Edit client
                                                                    </button>
                                                                    <form method="post" class="d-inline" onsubmit="return confirm('Delete this client? This action cannot be undone.');">
                                                                        {% csrf_token %}
                                                                        <input type="hidden" name="action" value="delete_client">
                                                                        <input type="hidden" name="client_id" value="{{ client.id }}">
                                                                        <button class="btn btn-outline-danger btn-sm" type="submit">
                                                                            <i class="mdi mdi-delete me-1"></i>Delete
                                                                        </button>
                                                                    </form>
                                                                </div>

                                                                <!-- Edit Client Form -->
                                                                <div class="collapse mb-3" id="clientEditCollapse-{{ client.id }}">
                                                                    <div class="border rounded p-3 bg-light">
                                                                        <h6 class="fw-semibold mb-3">Edit client details</h6>
                                                                        <form method="post" class="row g-2" id="clientEditForm-{{ client.id }}">
                                                                            {% csrf_token %}
                                                                            <input type="hidden" name="action" value="update_client">
                                                                            <input type="hidden" name="client_id" value="{{ client.id }}">
                                                                            {% for field in client.edit_form %}
                                                                                <div class="col-12">
                                                                                    <label class="form-label small fw-semibold" for="{{ field.id_for_label }}">
                                                                                        {{ field.label }}
                                                                                        {% if field.name == 'client_id' %}
                                                                                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="generateClientIdForEdit('{{ client.id }}')">
                                                                                                <i class="mdi mdi-refresh"></i> Generate
                                                                                            </button>
                                                                                        {% elif field.name == 'client_secret' %}
                                                                                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="generateClientSecretForEdit('{{ client.id }}')">
                                                                                                <i class="mdi mdi-refresh"></i> Generate
                                                                                            </button>
                                                                                        {% endif %}
                                                                                    </label>
                                                                                    {{ field }}
                                                                                    {% if field.help_text %}<small class="text-muted d-block mt-1">{{ field.help_text }}</small>{% endif %}
                                                                                    {% if field.errors %}<div class="text-danger small mt-1">{{ field.errors|join:", " }}</div>{% endif %}
                                                                                </div>
                                                                            {% endfor %}
                                                                            <div class="col-12 text-end mt-2">
                                                                                <button class="btn btn-primary btn-sm" type="submit">Save changes</button>
                                                                            </div>
                                                                        </form>
                                                                    </div>
                                                                </div>

                                                                <!-- Access Groups -->
                                                                <div class="border rounded p-3">
                                                                    <h6 class="fw-semibold mb-2">Access groups</h6>
                                                                    <p class="text-muted small mb-3">Control which user groups can authenticate with this client.</p>
                                                                    <form method="post" class="d-flex flex-column">
                                                                        {% csrf_token %}
                                                                        <input type="hidden" name="action" value="update_client_groups">
                                                                        <input type="hidden" name="client_id" value="{{ client.id }}">
                                                                        <div class="mb-3">
                                                                            {% if groups %}
                                                                                <div class="list-group">
                                                                                    {% for group in groups %}
                                                                                        <label class="list-group-item py-2 d-flex align-items-center">
                                                                                            <input class="form-check-input me-2 flex-shrink-0" type="checkbox" name="groups" value="{{ group.id }}" {% if access and group in access.groups.all %}checked{% endif %}>
                                                                                            <div class="flex-grow-1">
                                                                                                <span>{{ group.name }}</span>
                                                                                                <span class="text-muted small ms-2">({{ group.members.count }} member{{ group.members.count|pluralize }})</span>
                                                                                            </div>
                                                                                        </label>
                                                                                    {% endfor %}
                                                                                </div>
                                                                                <small class="text-muted d-block mt-2">
                                                                                    <i class="mdi mdi-information-outline me-1"></i>If no groups are selected, any account may SSO with this client.
                                                                                </small>
                                                                            {% else %}
                                                                                <div class="alert alert-info small mb-0">
                                                                                    No groups available. Create groups first to restrict client access.
                                                                                </div>
                                                                            {% endif %}
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <div class="form-check">
                                                                                <input class="form-check-input" type="checkbox" name="require_2fa" id="require_2fa_{{ client.id }}" {% if access and access.require_2fa %}checked{% endif %}>
                                                                                <label class="form-check-label" for="require_2fa_{{ client.id }}">
                                                                                    <strong>Require Two-Factor Authentication</strong>
                                                                                    <br><small class="text-muted">Users must complete TOTP verification to access this client</small>
                                                                                </label>
                                                                            </div>
                                                                        </div>
                                                                        <div class="text-end">
                                                                            <button class="btn btn-sm btn-outline-primary" type="submit">
                                                                                <i class="mdi mdi-content-save me-1"></i>Save access
                                                                            </button>
                                                                        </div>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endwith %}
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <div class="alert alert-info mb-3">
                                                <i class="mdi mdi-information-outline me-1"></i>No OIDC clients configured yet. Create one below to get started.
                                            </div>
                                        {% endif %}

                                        <!-- Create New Client -->
                                        {% if client_form %}
                                            <div class="border-top pt-3">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="fw-semibold mb-0">Create new client</h6>
                                                    <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#clientCreateCollapse" aria-expanded="false" aria-controls="clientCreateCollapse">
                                                        <i class="mdi mdi-plus me-1"></i>New OIDC client
                                                    </button>
                                                </div>
                                                <div class="collapse" id="clientCreateCollapse">
                                                    <div class="border rounded p-3 bg-light mt-2">
                                                        <form method="post" class="row g-2" id="clientCreateForm">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="action" value="create_client">
                                                            {% for field in client_form %}
                                                                <div class="col-12">
                                                                    <label class="form-label small fw-semibold" for="{{ field.id_for_label }}">
                                                                        {{ field.label }}
                                                                        {% if field.name == 'client_id' %}
                                                                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="generateClientId()">
                                                                                <i class="mdi mdi-refresh"></i> Generate
                                                                            </button>
                                                                        {% elif field.name == 'client_secret' %}
                                                                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="generateClientSecret()">
                                                                                <i class="mdi mdi-refresh"></i> Generate
                                                                            </button>
                                                                        {% endif %}
                                                                    </label>
                                                                    {{ field }}
                                                                    {% if field.help_text %}<small class="text-muted d-block mt-1">{{ field.help_text }}</small>{% endif %}
                                                                    {% if field.errors %}<div class="text-danger small mt-1">{{ field.errors|join:", " }}</div>{% endif %}
                                                                </div>
                                                            {% endfor %}
                                                            <div class="col-12 text-end mt-2">
                                                                <button class="btn btn-primary btn-sm" type="submit">
                                                                    <i class="mdi mdi-plus me-1"></i>Create client
                                                                </button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="alert alert-warning mb-0">
                                                <i class="mdi mdi-alert-outline me-1"></i>OIDC Provider not installed; client creation unavailable.
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h4 class="header-title mb-0">All aliases</h4>
                                            <span class="badge bg-secondary">{{ all_aliases|length }}</span>
                                        </div>
                                        <p class="text-muted mb-2">Browse aliases and see who they route to.</p>
                                        {% if all_aliases %}
                                            <div class="accordion" id="aliasAccordion">
                                                {% for alias in all_aliases %}
                                                    <div class="accordion-item mb-2">
                                                        <h2 class="accordion-header" id="alias-heading-{{ alias.id }}">
                                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#alias-body-{{ alias.id }}" aria-expanded="false" aria-controls="alias-body-{{ alias.id }}">
                                                                <div class="d-flex flex-column flex-md-row w-100">
                                                                    <span class="fw-semibold me-3">{{ alias.alias }}</span>
                                                                    <span class="text-muted small">Updated {% if alias.updated_at %}{{ alias.updated_at|date:"Y-m-d H:i" }}{% else %}&mdash;{% endif %}</span>
                                                                </div>
                                                            </button>
                                                        </h2>
                                                        <div id="alias-body-{{ alias.id }}" class="accordion-collapse collapse" aria-labelledby="alias-heading-{{ alias.id }}" data-bs-parent="#aliasAccordion">
                                                            <div class="accordion-body">
                                                                <div class="row">
                                                                    <div class="col-md-6">
                                                                        <div class="text-muted small mb-1">Owners</div>
                                                                        {% if alias.user %}
                                                                            <div>{{ alias.user.email }}</div>
                                                                        {% else %}
                                                                            <div class="text-muted">No owners</div>
                                                                        {% endif %}
                                                                    </div>
                                                                    <div class="col-md-6 d-flex align-items-center">
                                                                        <div>
                                                                            <div class="text-muted small mb-1">Created</div>
                                                                            <div>{% if alias.created_at %}{{ alias.created_at|date:"Y-m-d H:i" }}{% else %}&mdash;{% endif %}</div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <p class="text-muted mb-0">No aliases configured yet.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Application Settings -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="header-title mb-3">Application Settings</h4>
                                        <form method="post">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="update_settings">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold" for="{{ settings_form.session_timeout.id_for_label }}">
                                                        <i class="mdi mdi-timer-outline me-1"></i>Session Timeout
                                                    </label>
                                                    {{ settings_form.session_timeout }}
                                                    {% if settings_form.session_timeout.help_text %}
                                                        <small class="text-muted d-block mt-1">{{ settings_form.session_timeout.help_text }}</small>
                                                    {% endif %}
                                                    {% if settings_form.session_timeout.errors %}
                                                        <div class="text-danger small mt-1">{{ settings_form.session_timeout.errors|join:", " }}</div>
                                                    {% endif %}
                                                    <div class="mt-2">
                                                        <small class="text-muted">
                                                            <strong>Current:</strong> {{ app_settings.session_timeout }} seconds
                                                            ({{ app_settings.session_timeout|floatformat:0|add:"0"|divisibleby:"3600"|yesno:"~hours,~minutes" }})
                                                        </small>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold" for="{{ settings_form.domain_url.id_for_label }}">
                                                        <i class="mdi mdi-web me-1"></i>Domain URL
                                                    </label>
                                                    {{ settings_form.domain_url }}
                                                    {% if settings_form.domain_url.help_text %}
                                                        <small class="text-muted d-block mt-1">{{ settings_form.domain_url.help_text }}</small>
                                                    {% endif %}
                                                    {% if settings_form.domain_url.errors %}
                                                        <div class="text-danger small mt-1">{{ settings_form.domain_url.errors|join:", " }}</div>
                                                    {% endif %}
                                                    <div class="mt-2">
                                                        <small class="text-muted"><strong>Current:</strong> {{ app_settings.domain_url }}</small>
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="alert alert-info mb-0">
                                                        <i class="mdi mdi-information-outline me-1"></i>
                                                        <strong>Note:</strong> Session timeout applies to new logins. Domain URL is used for OIDC callbacks and email links.
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <hr class="my-3">
                                                    <h5 class="fw-semibold mb-3">SMTP (Outbound Email)</h5>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold" for="{{ settings_form.smtp_host.id_for_label }}">
                                                        <i class="mdi mdi-server-network me-1"></i>SMTP Host
                                                    </label>
                                                    {{ settings_form.smtp_host }}
                                                    {% if settings_form.smtp_host.help_text %}
                                                        <small class="text-muted d-block mt-1">{{ settings_form.smtp_host.help_text }}</small>
                                                    {% endif %}
                                                    {% if settings_form.smtp_host.errors %}
                                                        <div class="text-danger small mt-1">{{ settings_form.smtp_host.errors|join:", " }}</div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold" for="{{ settings_form.smtp_port.id_for_label }}">
                                                        <i class="mdi mdi-numeric me-1"></i>SMTP Port
                                                    </label>
                                                    {{ settings_form.smtp_port }}
                                                    {% if settings_form.smtp_port.help_text %}
                                                        <small class="text-muted d-block mt-1">{{ settings_form.smtp_port.help_text }}</small>
                                                    {% endif %}
                                                    {% if settings_form.smtp_port.errors %}
                                                        <div class="text-danger small mt-1">{{ settings_form.smtp_port.errors|join:", " }}</div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold" for="{{ settings_form.smtp_username.id_for_label }}">
                                                        <i class="mdi mdi-account-key-outline me-1"></i>SMTP Username
                                                    </label>
                                                    {{ settings_form.smtp_username }}
                                                    {% if settings_form.smtp_username.help_text %}
                                                        <small class="text-muted d-block mt-1">{{ settings_form.smtp_username.help_text }}</small>
                                                    {% endif %}
                                                    {% if settings_form.smtp_username.errors %}
                                                        <div class="text-danger small mt-1">{{ settings_form.smtp_username.errors|join:", " }}</div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold" for="{{ settings_form.smtp_password.id_for_label }}">
                                                        <i class="mdi mdi-lock-outline me-1"></i>SMTP Password
                                                    </label>
                                                    {{ settings_form.smtp_password }}
                                                    {% if settings_form.smtp_password.help_text %}
                                                        <small class="text-muted d-block mt-1">{{ settings_form.smtp_password.help_text }}</small>
                                                    {% endif %}
                                                    {% if settings_form.smtp_password.errors %}
                                                        <div class="text-danger small mt-1">{{ settings_form.smtp_password.errors|join:", " }}</div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-12">
                                                    <label class="form-label fw-semibold d-block">
                                                        <i class="mdi mdi-shield-lock-outline me-1"></i>SMTP Security
                                                    </label>
                                                    <div class="d-flex flex-wrap gap-3">
                                                        {% for radio in settings_form.smtp_security %}
                                                            <label class="form-check form-check-inline">
                                                                {{ radio.tag }}
                                                                <span class="ms-1">{{ radio.choice_label }}</span>
                                                            </label>
                                                        {% endfor %}
                                                    </div>
                                                    {% if settings_form.smtp_security.help_text %}
                                                        <small class="text-muted d-block mt-1">{{ settings_form.smtp_security.help_text }}</small>
                                                    {% endif %}
                                                    {% if settings_form.smtp_security.errors %}
                                                        <div class="text-danger small mt-1">{{ settings_form.smtp_security.errors|join:", " }}</div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-12">
                                                    <label class="form-label fw-semibold" for="{{ settings_form.smtp_from_email.id_for_label }}">
                                                        <i class="mdi mdi-email-outline me-1"></i>From Email
                                                    </label>
                                                    {{ settings_form.smtp_from_email }}
                                                    {% if settings_form.smtp_from_email.help_text %}
                                                        <small class="text-muted d-block mt-1">{{ settings_form.smtp_from_email.help_text }}</small>
                                                    {% endif %}
                                                    {% if settings_form.smtp_from_email.errors %}
                                                        <div class="text-danger small mt-1">{{ settings_form.smtp_from_email.errors|join:", " }}</div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-12">
                                                    <div class="alert alert-info mb-0">
                                                        <i class="mdi mdi-information-outline me-1"></i>
                                                        <strong>SMTP:</strong> Configure outbound email for password resets and notifications.
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <button class="btn btn-primary" type="submit">
                                                        <i class="mdi mdi-content-save me-1"></i>Save Settings
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div> <!-- container -->

                </div> <!-- content -->

                {% include "dockspace/components/footer.html" %}

            </div>

            <!-- ============================================================== -->
            <!-- End Page content -->
            <!-- ============================================================== -->


        </div>
        <!-- END wrapper -->


        {% include "dockspace/components/settings.html" %}


        <!-- bundle -->
        <script src="assets/js/vendor.min.js"></script>
        <script src="assets/js/app.min.js"></script>

        <!-- Charts removed to avoid canvas reuse errors -->
        <script>
        function pageSearch(query) {
            if (!query) return;
            const match = window.find(query, false, false, true, false, false, false);
            if (!match) {
                console.warn('No match for', query);
            }
        }
        function toggleGroupEdit(id) {
            const view = document.getElementById(`group-view-${id}`);
            const edit = document.getElementById(`group-edit-${id}`);
            if (!view || !edit) return;
            view.classList.toggle('d-none');
            edit.classList.toggle('d-none');
        }
        function toggleGroupCreate() {
            const create = document.getElementById('group-create-form');
            if (!create) return;
            create.classList.toggle('d-none');
        }
        function toggleAccountCreate() {
            const create = document.getElementById('account-create-form');
            if (!create) return;
            create.classList.toggle('d-none');
        }

        // Generate random client_id (24 characters: lowercase, digits, hyphens, underscores)
        function generateClientId() {
            const length = 24;
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789-_';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('id_client_id').value = result;
        }

        // Generate random client_secret (48 characters: secure random string)
        function generateClientSecret() {
            const length = 48;
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('id_client_secret').value = result;
        }

        // Generate random client_id for edit form (per client)
        function generateClientIdForEdit(clientId) {
            const length = 24;
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789-_';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            const field = document.querySelector(`#clientEditForm-${clientId} input[name="client_id"]`);
            if (field) field.value = result;
        }

        // Generate random client_secret for edit form (per client)
        function generateClientSecretForEdit(clientId) {
            const length = 48;
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            const field = document.querySelector(`#clientEditForm-${clientId} input[name="client_secret"]`);
            if (field) field.value = result;
        }
        </script>
        <!-- end demo js-->
    </body>

</html>
